# Cocoapods Compliance Scanner Plugin

A [Cocoapods](https://cocoapods.org/) plugin designed to scan third-party dependencies from both Cocoapods and [Swift Package Manager](https://www.swift.org/package-manager/) (SPM) used in Xcode projects. This plugin generates a [CycloneDX 1.4 JSON](https://cyclonedx.org/specification/overview/) report with customizable package urls ([purl](https://github.com/package-url/purl-spec)) to be used with TPSafe.

If you are just looking for a tool to scan your project's dependencies to create CycloneDX or SPDX BOMs, consider using [Syft](https://github.com/anchore/syft) instead using it's `swift` cataloger.

## Why Use This Plugin?

TPSafe currently does not support `pkg:cocoapods` and `pkg:swift/github.com` package urls, generated by tools like `Syft`. To make dependecies work with TPSafe, `pkg:generic` and `pkg:github` package urls are required that might need an additional parameter to pass the correct download url, for example when dependencies are based on branches or commit shas.

Summary of features provided by this plugin:
- purl types supported by TPSafe (e.g. `pkg:generic` and `pkg:github` instead of `pkg:cocoapods`)
- commit sha based version dependencies (from `:git => '...', :branch => '...')`)
- ignore dependencies with DEBUG configurations (`:configurations => ['Debug']`)
- purl parameters to pass additional information (e.g. `?download_url=...`)
- filter dependencies for selected target from Podfile 
- download the source code archive based on version, tag or commit sha

For commit dependencies installed from branch or commit sha versions, `cocoapods-compliance3` will generate pkg urls as for example:

`pkg:generic/cocoapods/SwiftChart@4949a94090641ca85b8133129f7a7b2230694788?download_url=https%3A%2F%2Fgithub.com%2Fgpbl%2FSwiftChart%2Farchive%2F4949a94090641ca85b8133129f7a7b2230694788.tar.gz`

Once TPSafe suppports `pkg:github` with commit shas and tags, `pkg:generic` might not be required anymore.

## Supported Package Urls

By default, the plugin generates the following purl types:
- `pkg:github` (e.g. `pkg:github/Alamofire/Alamofire@5.4.3`)

For dependencies with commit sha versions or when passing `--purl=generic` option:
- `pkg:generic` (e.g. `pkg:generic/cocoapods/Alamofire@5.4.3?download_url=https%3A%2F%2Fgithub.com%2FAlamofire%2FAlamofire%2Farchive%2F5.4.3.tar.gz`)

With `--purl=platform` option:
- `pkg:swift/github.com` (e.g. `pkg:swift/github.com/Alamofire/Alamofire@5.4.3`)
- `pkg:cocoapods` (e.g. `pkg:cocoapods/Alamofire@5.4.3`)

With `--purl=github` option:
- `pkg:github` (e.g. `pkg:github/Alamofire/Alamofire@5.4.3`)

## Installation

To install `cocoapods-compliance3`, follow these steps:

Add the plugin to your project's Gemfile and install the using bundler:

1. Open your project's Cocoapods `Gemfile` and add the following line in the same section where CocoaPods is imported:

```
gem 'cocoapods-compliance3', :git => 'https://github.softwareag.com/IOTA/cocoapods-compliance3', :tag => 'v1'
```

2. Install the bundle:
```
bundle install
```

As an alternative, you can install the plugin directly from the gem file. The gem file is released in the `Releases` section of the repository.  
   
To build and install the plugin from source, follow the instructions in the [Build from Source](#build-from-source) section.

## Usage

The Cocoapods Dependency Scanner Plugin is used by running the `pod compliance` command with various arguments. This command scans your project's dependencies and generates a CycloneDX 1.4 JSON report.

### Basic Syntax

```
pod compliance [options]
```

### Command Line Options

```
Options:
    -n, --name=COMPONENT      The component name used in CycloneDX metadata
    -v, --version=VERSION     The component version used in CycloneDX metadata
    -f, --filename=FILENAME   The output filename (default is tp_bom.json)
    -t, --target=TARGET       The Xcode target to collect compliance information for
    -x, --xcodeproj=PATH      The path to the Xcode project
    -d, --download=PATH       Download the source code of the dependencies to PATH
    -p, --purl                One of default, platform, github, generic
    -u, --urlparameter        The source download url parameter appended to PURL
                              (default is download_url)
    -a, --always              Always append source download URL to PURL (default is false)

    --allow-root              Allows CocoaPods to run as root
    --silent                  Show nothing
    --verbose                 Show more debugging information
    --no-ansi                 Show output without ANSI codes
    --help                    Show help banner of specified command
```

### Examples

1. Basic usage:
   ```
   pod compliance --component=MyApp --version=1.0 
   ```
   This command scans the dependencies for the default Xcode project in the current directory. It sets "MyApp" as the component name and "1.0" as the version in the CycloneDX metadata. The output will be saved as `tp_bom.json` in the current directory.

2. Specifying target and Xcode project:
   ```
   pod compliance --component=MyApp --version=2.1 --target=MyAppTarget --xcodeproj=./MyApp.xcodeproj 
   ```
   This command scans the dependencies for the specific target "MyAppTarget" in the "MyApp.xcodeproj" file. It sets "MyApp" as the component name and "2.1" as the version in the CycloneDX metadata. This is useful when you have multiple targets in your project and want to focus on a specific one.

3. Downloading source code:
   ```
   pod compliance --component=MyApp --version=1.5 --download=./downloads/
   ```
   This command scans the dependencies and also downloads the source code of the dependencies to the "./downloads/" directory. It sets "MyApp" as the component name and "1.5" as the version in the CycloneDX metadata. This is helpful when you need local copies of the dependency source code for further analysis or archiving.

4. Custom PURL and URL parameter:
   ```
   pod compliance --component=MyApp --version=1.5 --purl=github --urlparameter=source_url --always
   ```
   This command scans the dependencies with the following customizations:
   - Uses "github" as the PURL type (e.g., `pkg:github/owner/repo@version`)
   - Sets "source_url" as the parameter name for the download URL in the PURL
   - Always appends the download URL to the PURL, even for dependencies that aren't based on commit SHAs
   This is useful when you need a specific PURL format and want to ensure all dependencies have a source URL included in their PURL.

In all these examples, the plugin will generate a CycloneDX 1.4 JSON file (default name: `tp_bom.json`) containing a comprehensive list of your project's dependencies, including component names, versions, and package URLs (purls) for each dependency.

### CycloneDX Output

The plugin generates a CycloneDX 1.4 JSON file of your project's dependencies. This file includes the minimal set of details required for TPSafe, such as component names, versions, description, license and package URLs (purls) for each dependency.

CycloneDX sample output for a single component created by `cocoapods-compliance3`:

```json
{
  "bomFormat": "CycloneDX",
  "serialNumber": "urn:uuid:62814e4d-eec7-4233-97b7-6859a5bcbdf6",
  "version": "1",
  "specVersion": "1.4",
  "metadata": {
    "timestamp": "2024-09-08T05:41:59Z",
    "component": {
      "name": "sensor-app-ios",
      "version": "1.2"
    },
    "tools": [
      {
        "name": "cocoapods-compliance3",
        "version": "0.4.2"
      }
    ]
  },
  "components": [
    {
      "type": "library",
      "name": "Alamofire",
      "version": "5.9.1",
      "purl": "pkg:github/Alamofire/Alamofire@5.9.1",
      "author": "Alamofire Software Foundation <info@alamofire.org>",
      "description": "Elegant HTTP Networking in Swift",
      "licenses": [
        {
          "license": {
            "id": "MIT"
          }
        }
      ]
    }
  ]
}
```

## Build from Source

The plugin has been tested with 
- Xcode 15.4
- CocoaPods 1.15.2
- Ruby 3.1.6

To build and install the plugin from source, follow these steps:

```bash
bundle install
gem build cocoapods-compliance3.gemspec

# Install the plugin
gem install cocoapods-compliance3-x.y.z.gem
```

## Configuration

This plugin primarily uses command-line arguments for configuration. There are no additional configuration files or settings required beyond what's specified in the Usage section.

## License

This project is licensed under the MIT License. See the [LICENSE](LICENSE) file for details.

## Support

If you encounter any issues or have questions about cocoapods-compliance3, please:

1. Check the [GitHub Issues](https://github.com/yourusername/cocoapods-compliance3/issues) to see if your problem has already been reported.
2. If not, open a new issue with a clear description of the problem and steps to reproduce it.

## External Resources

- [Cocoapods Official Website](https://cocoapods.org/)
- [Swift Package Manager Documentation](https://www.swift.org/package-manager/)
- [CycloneDX Specification](https://cyclonedx.org/specification/overview/)
- [CycloneDX JSON Schema](https://cyclonedx.org/docs/1.4/json/)
- [GitHub Package URL Specification](https://github.com/package-url/purl-spec/blob/master/PURL-TYPES.rst#github)
- [Cocoapods Package URL Specification](https://github.com/package-url/purl-spec/blob/master/PURL-TYPES.rst#cocoapods)
- [Swift Package URL Specification](https://github.com/package-url/purl-spec/blob/master/PURL-TYPES.rst#swift)
- [Generic Package URL Specification](https://github.com/package-url/purl-spec/blob/master/PURL-TYPES.rst#generic)
- [Syft](https://github.com/anchore/syft)
```